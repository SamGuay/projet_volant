---
editor:
    markdown:
        wrap: 72
---

## √Ä la d√©couverte des expressions r√©guli√®res avec R (et d'autres packages au passage...)

Les **expressions r√©guli√®res** sont commun√©ment appel√©es **regex** ou
**regexp** pour **regular expressions** en anglais. Selon Wikip√©dia, une
expression r√©guli√®re est "une cha√Æne de caract√®res, qui d√©crit, selon
une syntaxe pr√©cise, un ensemble de cha√Ænes de caract√®res possibles". Si
vous n'avez jamais entendu parl√© des regex, il se peut que cette
d√©finition ne vous aide pas √† comprendre le concept. Nous tenterons de
d√©mystifier le tout au cours de ces exercices.

√Ä titre de rappel, cet
[aide-m√©moire](https://raw.githubusercontent.com/rstudio/cheatsheets/main/translations/french/regex_fr.pdf)
vous sera dr√¥lement utile!

En r√©sum√©, ces expressions permettent de d√©crire des motifs (patterns) √†
l'aide de formules "*relativement simples*" pour trouver, valider,
extraire ou modifier du texte ou des nombres.

## Mission d'aujourd'hui:

R√©colter le plus d'information possible qui se trouve dans les tableaux
de la page suivante:
<https://tc.canada.ca/fr/aviation/exploitation-aeroports-aerodromes/liste-aeroports-appartenant-transports-canada>.

```{r import}
library(tidyverse)
library(magrittr)
library(rvest)

```

```{r}
URL <- "https://tc.canada.ca/fr/aviation/exploitation-aeroports-aerodromes/liste-aeroports-appartenant-transports-canada"
```

### D√©but de solution en base R

```{r}
base_raw_html <- read_html(x = URL)
base_html_table <- html_elements(x = base_raw_html, css = "table")
base_tables <- html_table(x = base_html_table)

# base_table <- rbind(base_tables[[1]], base_tables[[2]], base_tables[[3]])

names(base_tables[[3]])
```

‚ö†Ô∏è Erreur! Une colonne n'est pas nomm√©e de fa√ßon identique, donc ne
fonctionne pas... Corrigeons la situation

```{r}

names(base_tables[[3]])[1] <- "Province/Territoire"

base_table <- rbind(base_tables[[1]], base_tables[[2]], base_tables[[3]])

base_table

# Solution en Base R
base_table$`Province/Territoire` <- ifelse(test = is.na(base_table$`Province/Territoire`),
                                  yes = base_table$Territoire, no = base_table$`Province/Territoire`)
base_table$Territoire <- NULL

rm(list=(ls(pattern = "base*")))
```

## Solution √† la Tidyverse

```{r}

URL <- "https://tc.canada.ca/fr/aviation/exploitation-aeroports-aerodromes/liste-aeroports-appartenant-transports-canada"


tables <- read_html(x = URL) %>%
    html_elements(css = "table") %>%
    html_table()

table <- dplyr::bind_rows(tables[[1]],
                          tables[[2]],
                          tables[[3]],
                          .id = "type")

# ou solution alternative √©quivalente
tables %>% purrr::map_dfr(bind_rows, .id = "type")






```

### Remplir les rang√©es de la colonne `Province/Territoire`

```{r}


table <- table %>% dplyr::rename(province_territoire = `Province/Territoire`,
                        aeroport = A√©roport,
                        exploited_by = `Exploit√© par`,
                        territoire = Territoire)

table$province_territoire <- dplyr::coalesce(table$province_territoire, 
                                              table$territoire)



table[table == ""] <- NA
# equivalent en tidyverse
table$province_territoire <- table$province_territoire %>% dplyr::na_if(y = "")
table <- table %>% tidyr::fill(province_territoire, .direction = "down")
# fill(x)
```

```{r}

table <- table %>% dplyr::select(-territoire)

```

Extraction des codes d'a√©roports

```{r}

# solution #1
x <- table %>% mutate(new_col = str_extract(string = aeroport, pattern = "[A-Z]{3}"))

table <- table %>% tidyr::extract(col = aeroport,
                         into = "code_aeroport",
                         regex = "(Y[A-Z][A-Z])", 
                         remove = FALSE)

table$aeroport <- table$aeroport %>%
    stringr::str_remove_all(pattern = "\\(.*\\)") %>%
    stringr::str_squish()


```

## Recodage des types d'a√©roport

```{r}

x <- table %>% mutate(type_nouveau = recode(type,
                                            "1" = "Petits a√©roports",
                                            "2" = "A√©roports nationaux", 
                                            "3" = "A√©roports nationaux exploit√©s par des administrations territoriales"))

x <- x %>% mutate(type_nouveau_case = case_when(type == 1 ~ "Petits a√©roports", 
                                               type == 2 ~ "A√©roports nationaux",
                                               type == 3 ~ "A√©roports nationaux exploit√©s par des administrations territoriales"))

```

## Il ne reste plus qu'√† extraire l'information qui se trouve dans `table$exploited_by`

```{r}
cat(table$exploited_by) 

```

Seulement si vous en avez envie... üôÉ
